<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#ff6b35">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>SPI ƒ∞≈ü Takip Sistemi</title>
  <link rel="icon" type="image/x-icon" href="spistakip.ico">
  <link rel="apple-touch-icon" href="spistakip.ico">
  <link rel="manifest" href="#" id="manifest-placeholder">
  
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    :root{
      --primary:#ff6b35;--primary-dark:#e55a2b;--secondary:#004e89;
      --success:#06d6a0;--warning:#ffd23f;--danger:#ef476f;--info:#118ab2;
      --dark:#1a1a1a;--gray:#2a2a2a;--light-gray:#3a3a3a;
      --text:#ffffff;--text-muted:#b0b0b0;
    }
    @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700;800&family=JetBrains+Mono:wght@400;600&display=swap');

    body{font-family:'Outfit',sans-serif;background:linear-gradient(135deg,#1a1a1a 0%,#2d1810 100%);color:var(--text);min-height:100vh}
    .container{max-width:1400px;margin:0 auto;padding:20px}
    .setup-card{max-width:900px;margin:50px auto;background:rgba(26,26,26,.95);backdrop-filter:blur(20px);
      padding:50px;border-radius:24px;border:1px solid rgba(255,107,53,.2);box-shadow:0 20px 60px rgba(0,0,0,.5)}
    .setup-title{font-size:36px;font-weight:800;margin-bottom:10px;background:linear-gradient(135deg,var(--primary),var(--warning));
      -webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .setup-subtitle{color:var(--text-muted);margin-bottom:30px;font-size:16px}
    .form-group{margin-bottom:18px}
    .form-label{display:block;margin-bottom:8px;font-weight:600;font-size:14px;color:var(--text-muted);
      text-transform:uppercase;letter-spacing:.5px}
    .form-input,.form-textarea,.form-select{width:100%;padding:14px 18px;background:var(--light-gray);border:2px solid transparent;
      border-radius:12px;color:var(--text);font-size:15px;font-family:'Outfit',sans-serif;transition:all .3s ease}
    .form-input:focus,.form-textarea:focus,.form-select:focus{outline:none;border-color:var(--primary);background:var(--gray)}
    .form-textarea{resize:vertical;min-height:110px;font-family:'JetBrains Mono',monospace;font-size:13px}
    .btn{padding:12px 24px;border:none;border-radius:12px;font-size:15px;font-weight:600;cursor:pointer;transition:all .3s ease;
      font-family:'Outfit',sans-serif;display:inline-flex;align-items:center;gap:8px;justify-content:center}
    .btn-primary{background:linear-gradient(135deg,var(--primary),var(--primary-dark));color:#fff;box-shadow:0 4px 15px rgba(255,107,53,.3)}
    .btn-primary:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(255,107,53,.4)}
    .btn-success{background:var(--success);color:#fff}
    .btn-danger{background:var(--danger);color:#fff}
    .btn-info{background:var(--info);color:#fff}
    .btn-ghost{background:transparent;border:2px solid var(--light-gray);color:var(--text)}
    .btn-secondary{background:rgba(0,78,137,.25);border:1px solid rgba(0,78,137,.6);color:#d8ebff}
    .info-box{background:rgba(255,107,53,.1);padding:20px;border-radius:12px;margin-bottom:22px;border-left:4px solid var(--primary)}
    .info-box h3{font-size:16px;margin-bottom:10px;color:var(--primary)}
    .info-box p{font-size:14px;color:var(--text-muted);line-height:1.6}
    
    /* Header with Logo */
    .header{background:rgba(26,26,26,.95);backdrop-filter:blur(10px);padding:20px;border-radius:16px;margin-bottom:30px;
      border:1px solid rgba(255,107,53,.1);box-shadow:0 8px 32px rgba(0,0,0,.3);
      display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px}
    .logo-container{display:flex;align-items:center;gap:15px}
    .logo-img{width:48px;height:48px;object-fit:contain;filter:drop-shadow(0 2px 8px rgba(255,107,53,.3))}
    .logo-text{font-size:28px;font-weight:800;background:linear-gradient(135deg,var(--primary),var(--warning));
      -webkit-background-clip:text;-webkit-text-fill-color:transparent;letter-spacing:-0.5px}
    
    /* Notification Bell */
    .notification-bell{position:relative;cursor:pointer;font-size:24px;padding:8px;border-radius:50%;transition:all .3s ease}
    .notification-bell:hover{background:var(--light-gray)}
    .notification-badge{position:absolute;top:0;right:0;background:var(--danger);color:#fff;font-size:10px;font-weight:700;
      padding:2px 6px;border-radius:10px;min-width:18px;text-align:center}
    
    .user-info{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .user-badge{background:var(--light-gray);padding:8px 16px;border-radius:20px;font-size:14px;display:flex;align-items:center;gap:8px}
    .role-badge{background:var(--primary);padding:4px 10px;border-radius:12px;font-size:12px;font-weight:600;text-transform:uppercase}
    
    .dashboard-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;margin-bottom:18px}
    .stat-card{background:rgba(42,42,42,.6);padding:25px;border-radius:16px;border:1px solid rgba(255,255,255,.05);transition:all .3s ease;cursor:pointer}
    .stat-card:hover{transform:translateY(-4px);border-color:rgba(255,107,53,.3);box-shadow:0 12px 40px rgba(0,0,0,.3)}
    .stat-value{font-size:42px;font-weight:800;margin-bottom:8px;background:linear-gradient(135deg,var(--primary),var(--warning));
      -webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .stat-label{color:var(--text-muted);font-size:14px;text-transform:uppercase;letter-spacing:1px}
    .stat-subtitle{color:var(--text-muted);font-size:12px;margin-top:5px}
    
    /* Charts */
    .chart-container{background:rgba(42,42,42,.8);padding:30px;border-radius:16px;margin-bottom:30px;border:1px solid rgba(255,255,255,.05)}
    .chart-title{font-size:20px;font-weight:700;margin-bottom:20px}
    .chart-canvas{width:100%;height:300px}
    
    /* Period Selector */
    .period-selector{display:flex;gap:10px;margin-bottom:20px;flex-wrap:wrap}
    .period-btn{padding:8px 16px;border:2px solid var(--light-gray);background:transparent;color:var(--text);
      border-radius:8px;cursor:pointer;transition:all .3s ease;font-size:14px;font-weight:600}
    .period-btn.active{background:var(--primary);border-color:var(--primary);color:#fff}
    
    .jobs-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(350px,1fr));gap:20px}
    .job-card{background:rgba(42,42,42,.8);padding:25px;border-radius:16px;border:1px solid rgba(255,255,255,.05);transition:all .3s ease;position:relative}
    .job-card::before{content:'';position:absolute;top:0;left:0;width:4px;height:100%;background:linear-gradient(180deg,var(--primary),var(--warning))}
    .job-card:hover{transform:translateY(-4px);box-shadow:0 12px 40px rgba(0,0,0,.4);border-color:rgba(255,107,53,.3)}
    .job-header{display:flex;justify-content:space-between;align-items:start;margin-bottom:15px;gap:10px}
    .job-title{font-size:20px;font-weight:700;margin-bottom:5px}
    .job-id{font-family:'JetBrains Mono',monospace;font-size:12px;color:var(--text-muted)}
    .job-status{padding:6px 12px;border-radius:20px;font-size:12px;font-weight:600;text-transform:uppercase;white-space:nowrap}
    .status-bekliyor{background:rgba(255,210,63,.2);color:var(--warning)}
    .status-devam{background:rgba(6,214,160,.2);color:var(--success)}
    .status-tamamlandi{background:rgba(176,176,176,.2);color:var(--text-muted)}
    .job-info{margin:15px 0;display:flex;flex-direction:column;gap:10px}
    .job-detail{display:flex;align-items:center;gap:10px;font-size:14px;color:var(--text-muted)}
    .job-actions{display:flex;gap:10px;margin-top:18px;flex-wrap:wrap}
    .job-actions .btn{flex:1;min-width:120px}
    
    .timer-display{background:var(--dark);padding:15px;border-radius:12px;margin:15px 0;text-align:center}
    .timer-value{font-family:'JetBrains Mono',monospace;font-size:32px;font-weight:700;color:var(--success)}
    .timer-label{font-size:12px;color:var(--text-muted);margin-top:5px}
    .timer-warning{background:rgba(255,210,63,.1);color:var(--warning);padding:8px;border-radius:8px;margin-top:10px;
      font-size:13px;border:1px solid rgba(255,210,63,.3)}
    
    .tabs{display:flex;gap:10px;margin:12px 0 24px;border-bottom:2px solid var(--light-gray);flex-wrap:wrap;overflow-x:auto}
    .tab{padding:12px 24px;background:transparent;border:none;color:var(--text-muted);font-size:16px;font-weight:600;
      cursor:pointer;position:relative;transition:all .3s ease;white-space:nowrap}
    .tab.active{color:var(--primary)}
    .tab.active::after{content:'';position:absolute;bottom:-2px;left:0;right:0;height:2px;background:var(--primary)}
    
    .modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.8);backdrop-filter:blur(5px);
      display:flex;align-items:center;justify-content:center;z-index:1000;padding:20px}
    .modal{background:var(--dark);border-radius:20px;max-width:800px;width:100%;max-height:90vh;overflow-y:auto;
      border:1px solid rgba(255,107,53,.2);box-shadow:0 20px 60px rgba(0,0,0,.5)}
    .modal-header{padding:26px;border-bottom:1px solid var(--light-gray)}
    .modal-title{font-size:22px;font-weight:700}
    .modal-body{padding:26px}
    .modal-footer{padding:18px 26px;border-top:1px solid var(--light-gray);display:flex;gap:10px;justify-content:flex-end;flex-wrap:wrap}
    
    .empty-state{text-align:center;padding:60px 20px;color:var(--text-muted)}
    .empty-icon{font-size:64px;margin-bottom:20px;opacity:.3}
    
    /* Progress Bar */
    .progress-bar{width:100%;height:8px;background:var(--light-gray);border-radius:4px;overflow:hidden;margin-top:10px}
    .progress-fill{height:100%;background:linear-gradient(90deg,var(--primary),var(--warning));transition:width .3s ease}
    
    /* Toast Notifications */
    .toast-container{position:fixed;top:20px;right:20px;z-index:10000;display:flex;flex-direction:column;gap:10px}
    .toast{background:var(--dark);padding:16px 20px;border-radius:12px;border-left:4px solid var(--primary);
      box-shadow:0 8px 24px rgba(0,0,0,.4);min-width:300px;animation:slideIn .3s ease}
    .toast-success{border-left-color:var(--success)}
    .toast-warning{border-left-color:var(--warning)}
    .toast-error{border-left-color:var(--danger)}
    .toast-info{border-left-color:var(--info)}
    .toast-title{font-weight:700;margin-bottom:5px}
    .toast-message{font-size:14px;color:var(--text-muted)}
    
    .fade-in{animation:fadeIn .5s ease}
    @keyframes fadeIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
    @keyframes slideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}
    @keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}
    .pulse{animation:pulse 2s ease-in-out infinite}
    
    /* Login Logo */
    .login-logo{width:80px;height:80px;margin:0 auto 20px;filter:drop-shadow(0 4px 12px rgba(255,107,53,.4))}
    
    .pill{display:inline-flex;align-items:center;gap:8px;background:rgba(255,107,53,.1);border:1px solid rgba(255,107,53,.2);
      padding:8px 12px;border-radius:999px;color:var(--text-muted);font-size:13px}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:700px){.grid2{grid-template-columns:1fr}
      .dashboard-grid{grid-template-columns:1fr}.jobs-grid{grid-template-columns:1fr}
      .job-actions{flex-direction:column}.job-actions .btn{width:100%}}
    .hint{font-size:12px;color:var(--text-muted);margin-top:6px;line-height:1.45}
    .danger-box{background:rgba(239,71,111,.12);border:1px solid rgba(239,71,111,.3);color:#ffb3c1;padding:12px;border-radius:12px;margin-bottom:14px}
    .success-box{background:rgba(6,214,160,.12);border:1px solid rgba(6,214,160,.3);color:#b7ffe9;padding:12px;border-radius:12px;margin-bottom:14px}
  </style>
</head>
<body>
  <div id="root"></div>
  <div id="toast-container" class="toast-container"></div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <!-- React -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script type="text/babel">
    // üîí SABƒ∞T FIREBASE CONFIG (TEK LINK)
const DEFAULT_FIREBASE_CONFIG = {
  apiKey: "AIzaSyCugtMDUMD9D6lxbpQ52_fOUV3WIoLrllo",
  authDomain: "sp-b-b272d.firebaseapp.com",
  projectId: "sp-b-b272d",
  messagingSenderId: "519404683421",
  appId: "1:519404683421:web:6e8a403c372e9fcd9d5474"
};

    const { useEffect, useMemo, useRef, useState } = React;

    // PWA Manifest
    const manifest = {
      name: "SPI ƒ∞≈ü Takip Sistemi",
      short_name: "SPI Takip",
      description: "Teknisyen i≈ü takip ve y√∂netim sistemi",
      start_url: "./",
      display: "standalone",
      background_color: "#1a1a1a",
      theme_color: "#ff6b35",
      icons: [{ src: "spistakip.ico", sizes: "48x48", type: "image/x-icon" }]
    };
    const manifestBlob = new Blob([JSON.stringify(manifest)], { type: 'application/json' });
    const manifestURL = URL.createObjectURL(manifestBlob);
    document.getElementById('manifest-placeholder').href = manifestURL;

    // ------------------------------
    // Utils & Helpers
    // ------------------------------
    const nowIso = () => new Date().toISOString();
    const safeTrim = (v) => (v ?? '').toString().trim();

    // Toast Notifications
    const showToast = (title, message, type = 'info') => {
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');
      toast.className = `toast toast-${type}`;
      toast.innerHTML = `<div class="toast-title">${title}</div><div class="toast-message">${message}</div>`;
      container.appendChild(toast);
      setTimeout(() => {
        toast.style.opacity = '0';
        setTimeout(() => toast.remove(), 300);
      }, 5000);
    };

    // Browser Notifications
    const requestNotificationPermission = async () => {
      if ('Notification' in window && Notification.permission === 'default') {
        const permission = await Notification.requestPermission();
        if (permission === 'granted') {
          showToast('Bildirimler Aktif', 'Artƒ±k bildirim alacaksƒ±nƒ±z!', 'success');
        }
      }
    };

    const sendNotification = (title, body) => {
      if ('Notification' in window && Notification.permission === 'granted') {
        new Notification(title, { body, icon: 'spistakip.ico', badge: 'spistakip.ico' });
      }
    };

    // ------------------------------
    // Timer with 1-hour Reminder
    // ------------------------------
    const Timer = ({ startTime, isPaused, onReminder }) => {
      const [elapsed, setElapsed] = useState(0);
      const [reminderShown, setReminderShown] = useState(false);

      useEffect(() => {
        if (isPaused) return;
        const interval = setInterval(() => {
          const seconds = Math.floor((Date.now() - new Date(startTime).getTime()) / 1000);
          setElapsed(seconds);

          if (seconds >= 3600 && !reminderShown) {
            setReminderShown(true);
            onReminder();
            sendNotification('‚è∞ 1 Saat Ge√ßti!', 'ƒ∞≈üinize devam ediyor musunuz? L√ºtfen durumu g√ºncelleyin.');
            showToast('‚è∞ Hatƒ±rlatma', '1 saatten fazla s√ºredir bu i≈ütesiniz. Devam ediyor musunuz?', 'warning');
          }
        }, 1000);
        return () => clearInterval(interval);
      }, [startTime, isPaused, reminderShown, onReminder]);

      const hours = Math.floor(elapsed / 3600);
      const minutes = Math.floor((elapsed % 3600) / 60);
      const seconds = elapsed % 60;
      const isOverOneHour = elapsed >= 3600;

      return (
        <div className="timer-display">
          <div className="timer-value" style={{ color: isOverOneHour ? 'var(--warning)' : 'var(--success)' }}>
            {String(hours).padStart(2, '0')}:{String(minutes).padStart(2, '0')}:{String(seconds).padStart(2, '0')}
          </div>
          <div className="timer-label">{isPaused ? 'DURAKLATILDI' : 'GE√áƒ∞Rƒ∞LEN S√úRE'}</div>
          {isOverOneHour && !isPaused && (
            <div className="timer-warning">‚ö†Ô∏è 1 saatten uzun s√ºredir √ßalƒ±≈üƒ±yorsunuz</div>
          )}
        </div>
      );
    };

    // ------------------------------
    // Statistics Chart
    // ------------------------------
    const WorkHoursChart = ({ period, data }) => {
      const canvasRef = useRef(null);
      const chartRef = useRef(null);

      useEffect(() => {
        if (!canvasRef.current || !data) return;
        const ctx = canvasRef.current.getContext('2d');
        if (chartRef.current) chartRef.current.destroy();

        chartRef.current = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: data.labels,
            datasets: [{
              label: '√áalƒ±≈üma Saati',
              data: data.values,
              backgroundColor: 'rgba(255, 107, 53, 0.6)',
              borderColor: 'rgba(255, 107, 53, 1)',
              borderWidth: 2,
              borderRadius: 8
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              tooltip: {
                backgroundColor: 'rgba(26, 26, 26, 0.9)',
                titleColor: '#fff',
                bodyColor: '#b0b0b0',
                borderColor: 'rgba(255, 107, 53, 0.5)',
                borderWidth: 1,
                padding: 12,
                displayColors: false,
                callbacks: { label: (ctx) => `${ctx.parsed.y.toFixed(1)} saat` }
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                grid: { color: 'rgba(255, 255, 255, 0.05)' },
                ticks: { color: '#b0b0b0', callback: (v) => v + 'h' }
              },
              x: {
                grid: { display: false },
                ticks: { color: '#b0b0b0' }
              }
            }
          }
        });

        return () => { if (chartRef.current) chartRef.current.destroy(); };
      }, [data]);

      return <canvas ref={canvasRef} className="chart-canvas"></canvas>;
    };

    // ------------------------------
    // Statistics View
    // ------------------------------
    const StatisticsView = ({ user, db }) => {
      const [period, setPeriod] = useState('week');
      const [chartData, setChartData] = useState(null);
      const [stats, setStats] = useState({ totalHours: 0, completedJobs: 0, avgDuration: 0, efficiency: 0 });

      useEffect(() => {
        loadStatistics();
      }, [period, user]);

      const loadStatistics = async () => {
        try {
          const now = new Date();
          let startDate;
          
          switch(period) {
            case 'today':
              startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
              break;
            case 'week':
              startDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
              break;
            case 'month':
              startDate = new Date(now.getFullYear(), now.getMonth(), 1);
              break;
          }

          const query = user.role === 'admin'
            ? db.collection('worklogs').where('createdAt', '>=', startDate.toISOString())
            : db.collection('worklogs').where('userId', '==', user.id).where('createdAt', '>=', startDate.toISOString());

          const snapshot = await query.get();
          const worklogs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

          const totalHours = worklogs.reduce((sum, log) => sum + (log.duration || 0), 0);
          const completedJobs = worklogs.length;
          const avgDuration = completedJobs > 0 ? totalHours / completedJobs : 0;

          setStats({
            totalHours: totalHours.toFixed(1),
            completedJobs,
            avgDuration: avgDuration.toFixed(1),
            efficiency: Math.min(100, Math.round((completedJobs / Math.max(1, now.getDate())) * 100))
          });

          const labels = [];
          const values = [];

          if (period === 'today') {
            for (let i = 0; i < 24; i++) {
              labels.push(i + ':00');
              const hourLogs = worklogs.filter(log => new Date(log.createdAt).getHours() === i);
              values.push(hourLogs.reduce((sum, log) => sum + (log.duration || 0), 0));
            }
          } else if (period === 'week') {
            const days = ['Pzt', 'Sal', '√áar', 'Per', 'Cum', 'Cmt', 'Paz'];
            for (let i = 0; i < 7; i++) {
              const date = new Date(now.getTime() - (6 - i) * 24 * 60 * 60 * 1000);
              labels.push(days[date.getDay()]);
              const dayLogs = worklogs.filter(log => new Date(log.createdAt).toDateString() === date.toDateString());
              values.push(dayLogs.reduce((sum, log) => sum + (log.duration || 0), 0));
            }
          } else {
            const weeksInMonth = Math.ceil(now.getDate() / 7);
            for (let i = 0; i < weeksInMonth; i++) {
              labels.push(`${i + 1}. Hafta`);
              const weekStart = new Date(now.getFullYear(), now.getMonth(), i * 7 + 1);
              const weekEnd = new Date(now.getFullYear(), now.getMonth(), (i + 1) * 7 + 1);
              const weekLogs = worklogs.filter(log => {
                const logDate = new Date(log.createdAt);
                return logDate >= weekStart && logDate < weekEnd;
              });
              values.push(weekLogs.reduce((sum, log) => sum + (log.duration || 0), 0));
            }
          }

          setChartData({ labels, values });
        } catch (error) {
          console.error('Statistics error:', error);
          showToast('Hata', 'ƒ∞statistikler y√ºklenirken hata olu≈ütu', 'error');
        }
      };

      return (
        <div className="fade-in">
          <div className="dashboard-grid">
            <div className="stat-card">
              <div className="stat-value">{stats.totalHours}</div>
              <div className="stat-label">Toplam Saat</div>
              <div className="stat-subtitle">
                {period === 'today' ? 'Bug√ºn' : period === 'week' ? 'Bu Hafta' : 'Bu Ay'}
              </div>
            </div>
            <div className="stat-card">
              <div className="stat-value">{stats.completedJobs}</div>
              <div className="stat-label">Tamamlanan ƒ∞≈ü</div>
              <div className="stat-subtitle">
                {period === 'today' ? 'Bug√ºn' : period === 'week' ? 'Bu Hafta' : 'Bu Ay'}
              </div>
            </div>
            <div className="stat-card">
              <div className="stat-value">{stats.avgDuration}</div>
              <div className="stat-label">Ort. S√ºre</div>
              <div className="stat-subtitle">ƒ∞≈ü Ba≈üƒ±na (saat)</div>
            </div>
            <div className="stat-card">
              <div className="stat-value">{stats.efficiency}%</div>
              <div className="stat-label">Verimlilik</div>
              <div className="stat-subtitle">Performans Skoru</div>
            </div>
          </div>

          <div className="chart-container">
            <div className="chart-title">√áalƒ±≈üma Saatleri Grafiƒüi</div>
            <div className="period-selector">
              <button className={`period-btn ${period === 'today' ? 'active' : ''}`} onClick={() => setPeriod('today')}>Bug√ºn</button>
              <button className={`period-btn ${period === 'week' ? 'active' : ''}`} onClick={() => setPeriod('week')}>Bu Hafta</button>
              <button className={`period-btn ${period === 'month' ? 'active' : ''}`} onClick={() => setPeriod('month')}>Bu Ay</button>
            </div>
            {chartData && <WorkHoursChart period={period} data={chartData} />}
          </div>
        </div>
      );
    };

    // ------------------------------
    // Login Component
    // ------------------------------
    const Login = ({ db, onLogin }) => {
      const [pin, setPin] = useState('');
      const [error, setError] = useState('');

      const handleSubmit = async (e) => {
        e.preventDefault();
        const p = safeTrim(pin);
        if (!p) {
          setError('PIN gerekli!');
          return;
        }

        try {
          const snap = await db.collection('users').where('pin', '==', p).get();
          if (snap.empty) {
            setError('Ge√ßersiz PIN!');
            setTimeout(() => setError(''), 2000);
            return;
          }

          const userData = snap.docs[0].data();
          await requestNotificationPermission();
          onLogin({ id: snap.docs[0].id, ...userData });
          showToast('Ho≈ü Geldiniz!', `${userData.name} olarak giri≈ü yaptƒ±nƒ±z`, 'success');
        } catch (err) {
          console.error(err);
          setError('Giri≈ü hatasƒ±: ' + (err.message || err));
        }
      };

      return (
        <div className="setup-card fade-in" style={{textAlign:'center'}}>
          <img src="spistakip.ico" alt="SPI Logo" className="login-logo" />
          <div className="setup-title">SPI ƒ∞≈ü Takip</div>
          <div className="setup-subtitle">PIN kodunuzu girin</div>
          {error && <div className="danger-box">{error}</div>}
          <form onSubmit={handleSubmit}>
            <div className="form-group">
              <input
                type="password"
                className="form-input"
                value={pin}
                onChange={e => setPin(e.target.value)}
                placeholder="4 haneli PIN"
                maxLength="4"
                autoFocus
                style={{textAlign:'center',fontSize:'24px',letterSpacing:'8px'}}
              />
            </div>
            <button type="submit" className="btn btn-primary" style={{width:'100%'}}>Giri≈ü Yap</button>
          </form>
        </div>
      );
    };

    // ------------------------------
    // Complete Job Modal
    // ------------------------------
    const CompleteJobModal = ({ job, db, onClose, onComplete }) => {
      const [duration, setDuration] = useState('');
      const [notes, setNotes] = useState('');
      const [uploading, setUploading] = useState(false);

      const handleComplete = async () => {
        if (!duration) {
          showToast('Eksik Bilgi', 'L√ºtfen s√ºre girin!', 'warning');
          return;
        }

        setUploading(true);
        try {
          const worklog = {
            jobId: job.id,
            userId: job.assignedTo,
            startTime: job.startTime,
            endTime: nowIso(),
            duration: parseFloat(duration),
            notes: safeTrim(notes),
            createdAt: nowIso()
          };

          await db.collection('worklogs').add(worklog);
          await db.collection('jobs').doc(job.id).update({ status: 'tamamlandi', completedAt: nowIso() });

          showToast('ƒ∞≈ü Tamamlandƒ±!', `${job.title} ba≈üarƒ±yla tamamlandƒ±`, 'success');
          sendNotification('‚úÖ ƒ∞≈ü Tamamlandƒ±', job.title);
          onComplete();
          onClose();
        } catch (err) {
          console.error(err);
          showToast('Hata', 'ƒ∞≈ü tamamlanƒ±rken hata olu≈ütu', 'error');
        } finally {
          setUploading(false);
        }
      };

      return (
        <div className="modal-overlay" onClick={onClose}>
          <div className="modal fade-in" onClick={e => e.stopPropagation()}>
            <div className="modal-header">
              <div className="modal-title">ƒ∞≈üi Tamamla</div>
              <div style={{fontSize:'14px',color:'var(--text-muted)',marginTop:'5px'}}>{job.title}</div>
            </div>
            <div className="modal-body">
              <div className="form-group">
                <label className="form-label">Harcanan S√ºre (Saat)</label>
                <input
                  type="number"
                  step="0.5"
                  className="form-input"
                  value={duration}
                  onChange={e => setDuration(e.target.value)}
                  placeholder="√ñrn: 2.5"
                  disabled={uploading}
                />
              </div>
              <div className="form-group">
                <label className="form-label">A√ßƒ±klama / Notlar</label>
                <textarea
                  className="form-textarea"
                  value={notes}
                  onChange={e => setNotes(e.target.value)}
                  placeholder="Yapƒ±lan i≈ülem detaylarƒ±..."
                  disabled={uploading}
                />
              </div>
            </div>
            <div className="modal-footer">
              <button className="btn btn-ghost" onClick={onClose} disabled={uploading}>ƒ∞ptal</button>
              <button className="btn btn-success" onClick={handleComplete} disabled={uploading}>
                {uploading ? '‚è≥ Kaydediliyor...' : '‚úì Tamamla'}
              </button>
            </div>
          </div>
        </div>
      );
    };

    // ------------------------------
    // Job Card Component
    // ------------------------------
    const JobCard = ({ job, user, db, onUpdate }) => {
      const [showCompleteModal, setShowCompleteModal] = useState(false);
      const [showReminder, setShowReminder] = useState(false);

      const handleStart = async () => {
        await db.collection('jobs').doc(job.id).update({ status: 'devam', startTime: nowIso(), isPaused: false });
        showToast('ƒ∞≈ü Ba≈ülatƒ±ldƒ±', job.title, 'success');
        sendNotification('‚ñ∂Ô∏è ƒ∞≈ü Ba≈ülatƒ±ldƒ±', job.title);
      };

      const handlePause = async () => {
        await db.collection('jobs').doc(job.id).update({ isPaused: !job.isPaused });
        showToast(job.isPaused ? 'ƒ∞≈ü Devam Ediyor' : 'ƒ∞≈ü Duraklatƒ±ldƒ±', job.title, 'info');
      };

      const handleReminder = () => setShowReminder(true);

      const statusLabels = { bekliyor: 'Bekliyor', devam: 'Devam Ediyor', tamamlandi: 'Tamamlandƒ±' };
      const priorityColors = { 'Y√ºksek': '#ef476f', 'Normal': '#ffd23f', 'D√º≈ü√ºk': '#06d6a0' };

      return (
        <>
          <div className="job-card fade-in">
            <div className="job-header">
              <div>
                <div className="job-title">{job.title}</div>
                <div className="job-id">{job.id}</div>
              </div>
              <div className={`job-status status-${job.status}`}>{statusLabels[job.status]}</div>
            </div>
            <div className="job-info">
              <div className="job-detail"><span>üìç</span> {job.location}</div>
              <div className="job-detail"><span>üîß</span> {job.type}</div>
              <div className="job-detail"><span>‚è±Ô∏è</span> Tahmini: {job.estimatedTime}</div>
              <div className="job-detail">
                <span>‚ö°</span>
                <span style={{color:priorityColors[job.priority]}}>{job.priority} √ñncelik</span>
              </div>
            </div>
            {job.description && (
              <div style={{marginTop:'15px',padding:'12px',background:'var(--dark)',borderRadius:'8px',fontSize:'14px',color:'var(--text-muted)'}}>
                {job.description}
              </div>
            )}
            {job.status === 'devam' && job.startTime && (
              <Timer startTime={job.startTime} isPaused={job.isPaused} onReminder={handleReminder} />
            )}
            {showReminder && (
              <div style={{background:'rgba(255,210,63,.1)',padding:'12px',borderRadius:'8px',marginTop:'10px',border:'1px solid rgba(255,210,63,.3)',fontSize:'14px'}}>
                ‚ö†Ô∏è Devam ediyor musunuz?
                <div style={{marginTop:'10px',display:'flex',gap:'10px'}}>
                  <button className="btn btn-success" style={{flex:1,fontSize:'13px',padding:'8px'}} onClick={() => setShowReminder(false)}>‚úì Evet</button>
                  <button className="btn btn-danger" style={{flex:1,fontSize:'13px',padding:'8px'}} onClick={() => { setShowReminder(false); setShowCompleteModal(true); }}>‚úó Tamamla</button>
                </div>
              </div>
            )}
            <div className="job-actions">
              {job.status === 'bekliyor' && <button className="btn btn-success" onClick={handleStart}>‚ñ∂ Ba≈ülat</button>}
              {job.status === 'devam' && (
                <>
                  <button className="btn btn-secondary" onClick={handlePause}>{job.isPaused ? '‚ñ∂ Devam' : '‚è∏ Duraklat'}</button>
                  <button className="btn btn-primary" onClick={() => setShowCompleteModal(true)}>‚úì Tamamla</button>
                </>
              )}
            </div>
          </div>
          {showCompleteModal && (
            <CompleteJobModal job={job} db={db} onClose={() => setShowCompleteModal(false)} onComplete={onUpdate} />
          )}
        </>
      );
    };

    // ------------------------------
    // Create Job Modal (Admin only)
    // ------------------------------
    const CreateJobModal = ({ db, technicians, adminUser, onClose }) => {
      const [title, setTitle] = useState('');
      const [description, setDescription] = useState('');
      const [location, setLocation] = useState('');
      const [type, setType] = useState('');
      const [assignedTo, setAssignedTo] = useState('');
      const [priority, setPriority] = useState('Normal');
      const [estimatedTime, setEstimatedTime] = useState('');

      const handleCreate = async (e) => {
        e.preventDefault();
        if (!safeTrim(title) || !assignedTo) {
          showToast('Eksik Bilgi', 'Ba≈ülƒ±k ve Teknisyen gerekli!', 'warning');
          return;
        }

        try {
          await db.collection('jobs').add({
            title: safeTrim(title),
            description: safeTrim(description),
            location: safeTrim(location),
            type: safeTrim(type),
            assignedTo,
            status: 'bekliyor',
            priority,
            estimatedTime: safeTrim(estimatedTime),
            createdBy: adminUser.id,
            createdAt: nowIso()
          });

          showToast('ƒ∞≈ü Olu≈üturuldu!', `${title} ba≈üarƒ±yla eklendi`, 'success');
          onClose();
        } catch (err) {
          console.error(err);
          showToast('Hata', 'ƒ∞≈ü eklenirken hata olu≈ütu', 'error');
        }
      };

      return (
        <div className="modal-overlay" onClick={onClose}>
          <div className="modal fade-in" onClick={e => e.stopPropagation()}>
            <div className="modal-header"><div className="modal-title">‚ûï Yeni ƒ∞≈ü Ekle</div></div>
            <form onSubmit={handleCreate}>
              <div className="modal-body">
                <div className="grid2">
                  <div className="form-group">
                    <label className="form-label">ƒ∞≈ü Ba≈ülƒ±ƒüƒ±</label>
                    <input className="form-input" value={title} onChange={e => setTitle(e.target.value)} placeholder="√ñrn: Hat 3 Elektrik Arƒ±zasƒ±" />
                  </div>
                  <div className="form-group">
                    <label className="form-label">Teknisyen</label>
                    <select className="form-select" value={assignedTo} onChange={e => setAssignedTo(e.target.value)}>
                      <option value="">Se√ßin</option>
                      {technicians.map(t => <option key={t.id} value={t.id}>{t.name}</option>)}
                    </select>
                  </div>
                </div>
                <div className="form-group">
                  <label className="form-label">A√ßƒ±klama</label>
                  <textarea className="form-textarea" value={description} onChange={e => setDescription(e.target.value)} placeholder="Detaylƒ± a√ßƒ±klama" />
                </div>
                <div className="grid2">
                  <div className="form-group">
                    <label className="form-label">Lokasyon</label>
                    <input className="form-input" value={location} onChange={e => setLocation(e.target.value)} placeholder="√ñrn: Hat 3 - Makine A12" />
                  </div>
                  <div className="form-group">
                    <label className="form-label">ƒ∞≈ü Tipi</label>
                    <input className="form-input" value={type} onChange={e => setType(e.target.value)} placeholder="√ñrn: Elektrik" />
                  </div>
                </div>
                <div className="grid2">
                  <div className="form-group">
                    <label className="form-label">√ñncelik</label>
                    <select className="form-select" value={priority} onChange={e => setPriority(e.target.value)}>
                      <option value="D√º≈ü√ºk">D√º≈ü√ºk</option>
                      <option value="Normal">Normal</option>
                      <option value="Y√ºksek">Y√ºksek</option>
                    </select>
                  </div>
                  <div className="form-group">
                    <label className="form-label">Tahmini S√ºre</label>
                    <input className="form-input" value={estimatedTime} onChange={e => setEstimatedTime(e.target.value)} placeholder="√ñrn: 2 saat" />
                  </div>
                </div>
              </div>
              <div className="modal-footer">
                <button type="button" className="btn btn-ghost" onClick={onClose}>ƒ∞ptal</button>
                <button type="submit" className="btn btn-primary">‚ûï Ekle</button>
              </div>
            </form>
          </div>
        </div>
      );
    };

    // ------------------------------
    // Users Modal (Admin only)
    // ------------------------------
    const UsersModal = ({ db, onClose }) => {
      const [users, setUsers] = useState([]);

      useEffect(() => {
        const unsubscribe = db.collection('users').onSnapshot(snap => {
          setUsers(snap.docs.map(d => ({ id: d.id, ...d.data() })));
        });
        return () => unsubscribe();
      }, [db]);

      return (
        <div className="modal-overlay" onClick={onClose}>
          <div className="modal fade-in" onClick={e => e.stopPropagation()}>
            <div className="modal-header"><div className="modal-title">üë• Kullanƒ±cƒ±lar</div></div>
            <div className="modal-body">
              {users.map(u => (
                <div key={u.id} style={{padding:'12px',background:'var(--light-gray)',borderRadius:'8px',marginBottom:'10px',display:'flex',justifyContent:'space-between',alignItems:'center'}}>
                  <div>
                    <div style={{fontWeight:700}}>{u.name}</div>
                    <div style={{fontSize:'13px',color:'var(--text-muted)'}}>{u.role} ‚Ä¢ PIN: {u.pin}</div>
                  </div>
                  <span className="role-badge">{u.role}</span>
                </div>
              ))}
            </div>
            <div className="modal-footer">
              <button className="btn btn-ghost" onClick={onClose}>Kapat</button>
            </div>
          </div>
        </div>
      );
    };

    // ------------------------------
    // Dashboard Component
    // ------------------------------
    const Dashboard = ({ user, db, onLogout }) => {
      const [jobs, setJobs] = useState([]);
      const [technicians, setTechnicians] = useState([]);
      const [activeTab, setActiveTab] = useState('jobs');
      const [jobsSubTab, setJobsSubTab] = useState('active');
      const [showCreateJob, setShowCreateJob] = useState(false);
      const [showUsers, setShowUsers] = useState(false);

      // Load technicians (admin only)
      useEffect(() => {
        if (user.role !== 'admin') return;
        const unsubscribe = db.collection('users').where('role', '==', 'teknisyen').onSnapshot(snap => {
          setTechnicians(snap.docs.map(d => ({ id: d.id, ...d.data() })));
        });
        return () => unsubscribe();
      }, [user, db]);

      // Jobs subscription
      useEffect(() => {
        let unsubscribe;
        if (user.role === 'admin') {
          unsubscribe = db.collection('jobs').onSnapshot(snapshot => {
            const list = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            setJobs(list);
          });
        } else {
          unsubscribe = db.collection('jobs').where('assignedTo', '==', user.id).onSnapshot(snapshot => {
            const list = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            setJobs(list);
          });
        }
        return () => unsubscribe && unsubscribe();
      }, [user, db]);

      const activeJobs = jobs.filter(j => j.status !== 'tamamlandi');
      const completedJobs = jobs.filter(j => j.status === 'tamamlandi');
      const displayJobs = jobsSubTab === 'active' ? activeJobs : completedJobs;

      const stats = {
        total: activeJobs.length,
        waiting: jobs.filter(j => j.status === 'bekliyor').length,
        inProgress: jobs.filter(j => j.status === 'devam').length,
        completed: completedJobs.length
      };

      return (
        <div className="container">
          <div className="header fade-in">
            <div className="logo-container">
              <img src="spistakip.ico" alt="SPI Logo" className="logo-img" />
              <div className="logo-text">SPI ƒ∞≈ü Takip {user.role === 'admin' && '(Admin)'}</div>
            </div>
            <div className="user-info">
              <div className="notification-bell">
                üîî
                {stats.inProgress > 0 && <span className="notification-badge">{stats.inProgress}</span>}
              </div>
              <div className="user-badge">
                <span>üë§</span>
                <span>{user.name}</span>
                <span className="role-badge">{user.role}</span>
              </div>
              {user.role === 'admin' && (
                <>
                  <button className="btn btn-primary" onClick={() => setShowCreateJob(true)}>‚ûï ƒ∞≈ü Ekle</button>
                  <button className="btn btn-ghost" onClick={() => setShowUsers(true)}>üë• Kullanƒ±cƒ±lar</button>
                </>
              )}
              <button className="btn btn-ghost" onClick={onLogout}>√áƒ±kƒ±≈ü</button>
            </div>
          </div>

          <div className="dashboard-grid fade-in">
            <div className="stat-card">
              <div className="stat-value">{stats.total}</div>
              <div className="stat-label">Aktif ƒ∞≈üler</div>
            </div>
            <div className="stat-card">
              <div className="stat-value">{stats.waiting}</div>
              <div className="stat-label">Bekleyenler</div>
            </div>
            <div className="stat-card">
              <div className="stat-value">{stats.inProgress}</div>
              <div className="stat-label">Devam Eden</div>
            </div>
            <div className="stat-card">
              <div className="stat-value">{stats.completed}</div>
              <div className="stat-label">Tamamlanan</div>
            </div>
          </div>

          <div className="tabs">
            <button className={`tab ${activeTab === 'jobs' ? 'active' : ''}`} onClick={() => setActiveTab('jobs')}>
              üìã ƒ∞≈üler
            </button>
            <button className={`tab ${activeTab === 'statistics' ? 'active' : ''}`} onClick={() => setActiveTab('statistics')}>
              üìä ƒ∞statistikler
            </button>
          </div>

          {activeTab === 'jobs' && (
            <>
              <div className="tabs">
                <button className={`tab ${jobsSubTab === 'active' ? 'active' : ''}`} onClick={() => setJobsSubTab('active')}>
                  üî• Aktif ƒ∞≈üler ({activeJobs.length})
                </button>
                <button className={`tab ${jobsSubTab === 'completed' ? 'active' : ''}`} onClick={() => setJobsSubTab('completed')}>
                  ‚úì Tamamlananlar ({completedJobs.length})
                </button>
              </div>

              {displayJobs.length === 0 ? (
                <div className="empty-state">
                  <div className="empty-icon">üì≠</div>
                  <div>{jobsSubTab === 'active' ? 'Aktif i≈ü bulunmuyor' : 'Hen√ºz tamamlanmƒ±≈ü i≈ü yok'}</div>
                </div>
              ) : (
                <div className="jobs-grid">
                  {displayJobs.map(job => <JobCard key={job.id} job={job} user={user} db={db} onUpdate={() => {}} />)}
                </div>
              )}
            </>
          )}

          {activeTab === 'statistics' && <StatisticsView user={user} db={db} />}

          {showCreateJob && <CreateJobModal db={db} technicians={technicians} adminUser={user} onClose={() => setShowCreateJob(false)} />}
          {showUsers && <UsersModal db={db} onClose={() => setShowUsers(false)} />}
        </div>
      );
    };

    // ------------------------------
    // Main App
    // ------------------------------
    const App = () => {
      const [firebaseConfig, setFirebaseConfig] = useState(null);
      const [user, setUser] = useState(null);
      const [db, setDb] = useState(null);

      useEffect(() => {
        try {
          const savedConfig = localStorage.getItem('firebaseConfig');
          if (savedConfig) {
            const cfg = JSON.parse(savedConfig);
            initializeFirebase(cfg);
          } else {
            localStorage.setItem('firebaseConfig', JSON.stringify(DEFAULT_FIREBASE_CONFIG));
            initializeFirebase(DEFAULT_FIREBASE_CONFIG);
          }
        } catch (e) {
          localStorage.setItem('firebaseConfig', JSON.stringify(DEFAULT_FIREBASE_CONFIG));
          initializeFirebase(DEFAULT_FIREBASE_CONFIG);
        }
      }, []);

      const initializeFirebase = (config) => {
        try {
          if (!firebase.apps.length) firebase.initializeApp(config);
          setDb(firebase.firestore());
          setFirebaseConfig(config);
          showToast('Baƒülantƒ± Kuruldu', 'Firebase ba≈üarƒ±yla baƒülandƒ±', 'success');
        } catch (err) {
          console.error('Firebase init error', err);
          showToast('Baƒülantƒ± Hatasƒ±', 'Firebase baƒülanƒ±rken hata: ' + (err?.message || err), 'error');
        }
      };

      if (!firebaseConfig) return <div className="setup-card fade-in"><div className="setup-title">‚è≥ Ba≈ülatƒ±lƒ±yor...</div></div>;
      if (!db) return <div className="setup-card fade-in"><div className="setup-title">‚è≥ Baƒülanƒ±yor...</div></div>;
      if (!user) return <Login db={db} onLogin={setUser} />;

      return <Dashboard user={user} db={db} onLogout={() => setUser(null)} />;
    };

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>
